<% this_issue ||= nil %>

<script>


  function initialize() {

    <%
      coord_stats = get_issue_coord_stats(issues) || {}
      if this_issue.present?
        this_lat = this_issue.lat
        this_lng = this_issue.lng
      else
        this_lat, this_lng = coord_stats[:average_coord]
      end
    %>

    var mapCenter = new google.maps.LatLng(<%= this_lat %>, <%= this_lng %>);
    var mapOptions = {
      zoom: <%= coord_stats[:max_spread] ? (1.0/coord_stats[:max_spread]).to_i : 15 %>,
      center: mapCenter
    };

    var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

    <%
      issue_counter = issues.count + 1
      locations = issues.collect do |issue|
        [
          generate_issue_title(issue),
          issue.lat,
          issue.lng,
          (issue_counter -= 1),
          marker_style(issue.priority, issue.state),
          formatted_description(issue)
        ]
      end
    %>
    var locations = <%=raw locations %>;

    for (var i = 0; i < locations.length; i++) {
      createMarker(map, locations[i]);
    }

    <% if this_issue.present? %>
      var myTitle = "<%= this_issue.title %>";
      var myLat = <%= this_issue.lat %>;
      var myLng = <%= this_issue.lng %>;
      var zIndex = 10000;
      var icon = "http://maps.google.com/mapfiles/ms/icons/pink.png";
      var description = "<%= formatted_description this_issue %>";
      createMarker(map,[myTitle, myLat, myLng, zIndex, icon, description]);
    <% end %>

    <% if defined?(your_coord) %>
      var myTitle = "Your Location";
      var myLat = <%= your_coord[:lat] %>;
      var myLng = <%= your_coord[:lng] %>;
      var zIndex = 10000;
      var icon = '/images/crosshair.svg';
      var description = "";
      createMarker(map,[myTitle, myLat, myLng, zIndex, icon, description]);
    <% end %>


    var GLOBE_WIDTH = 256; // a constant in Google's map projection

    <% if this_issue.present? %>
      map.setZoom(17);
      var bikeLayer = new google.maps.BicyclingLayer();
      bikeLayer.setMap(map);
    <% else %>
      var lon_angle = <%= coord_stats[:max_lng] %> - <%= coord_stats[:min_lng] %>;
      var lat_angle = <%= coord_stats[:max_lat] %> - <%= coord_stats[:min_lat] %>;

      var angle = lon_angle.abs > lat_angle.abs*2 ? lon_angle : lat_angle;
      if (angle < 0) {
        angle += 360;
      }
      pixelWidth = 600;
      var zoom = Math.round(Math.log(pixelWidth * 360 / angle / GLOBE_WIDTH) / Math.LN2);
      map.setZoom(zoom-2);

      if(map.getZoom()> 15){
        map.setZoom(15);
      }
    <% end %>

  }

  function createMarker(map, location) {
      var contentString = location[5];

      var infowindow = new google.maps.InfoWindow({
          content: contentString
      });

      var myLatLng = new google.maps.LatLng(location[1], location[2]);

      var marker = new google.maps.Marker({
          position: myLatLng,
          map: map,
          icon: location[4],
          title: location[0],
          zIndex: location[3]
      });
      google.maps.event.addListener(marker, 'click', function() {
        infowindow.open(map,marker);
      });
      return marker;
  }

</script>
